#!/bin/bash

# Install Powerlevel10k theme for Oh My Zsh
# Check for Oh My Zsh installation at runtime

if [[ -d "${XDG_DATA_HOME:-$HOME/.local/share}/oh-my-zsh" ]] || [[ -d "$HOME/.oh-my-zsh" ]]; then
POWERLEVEL10K_DIR="${ZSH_CUSTOM:-${XDG_DATA_HOME:-$HOME/.local/share}/oh-my-zsh/custom}/themes/powerlevel10k"

if [ ! -d "$POWERLEVEL10K_DIR" ]; then
    echo "Installing Powerlevel10k theme..."
    git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "$POWERLEVEL10K_DIR"
else
    echo "Powerlevel10k already installed"
fi

# Install MesloLGS NF font (recommended for Powerlevel10k)
echo ""
echo "Installing MesloLGS Nerd Font for Powerlevel10k..."

{{- if .is_macos }}
# macOS font installation
FONT_DIR="$HOME/Library/Fonts"
mkdir -p "$FONT_DIR"

# Check if font is already installed
if ! ls "$FONT_DIR"/MesloLGS*.ttf >/dev/null 2>&1; then
    echo "Downloading and installing MesloLGS NF fonts..."
    for style in Regular Bold Italic Bold-Italic; do
        font_file="MesloLGS NF ${style}.ttf"
        font_url="https://github.com/romkatv/powerlevel10k-media/raw/master/${font_file// /%20}"
        curl -fsSL "$font_url" -o "$FONT_DIR/$font_file"
        echo "  ✓ Installed $font_file"
    done
    echo "Fonts installed successfully! You may need to restart your terminal."
else
    echo "MesloLGS NF fonts already installed"
fi
{{- end }}

{{- if .is_linux }}
# Linux font installation
FONT_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/fonts"
mkdir -p "$FONT_DIR"

# Check if font is already installed
if ! ls "$FONT_DIR"/MesloLGS*.ttf >/dev/null 2>&1; then
    echo "Downloading and installing MesloLGS NF fonts..."
    for style in Regular Bold Italic Bold-Italic; do
        font_file="MesloLGS NF ${style}.ttf"
        font_url="https://github.com/romkatv/powerlevel10k-media/raw/master/${font_file// /%20}"
        curl -fsSL "$font_url" -o "$FONT_DIR/$font_file"
        echo "  ✓ Installed $font_file"
    done
    # Update font cache
    if command -v fc-cache >/dev/null 2>&1; then
        echo "Updating font cache..."
        fc-cache -f "$FONT_DIR"
    fi
    echo "Fonts installed successfully! You may need to restart your terminal."
else
    echo "MesloLGS NF fonts already installed"
fi
{{- end }}

echo ""
echo "Note: Make sure to select 'MesloLGS NF' as your terminal font for the best experience."
echo ""
else
    echo "Oh My Zsh not found, skipping Powerlevel10k installation"
    echo "Install Oh My Zsh first, then run 'chezmoi apply' again"
fi