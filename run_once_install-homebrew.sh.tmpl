#!/bin/bash

# Install Homebrew on macOS and Linux if not already installed
if ! command -v brew &> /dev/null; then
    echo "Homebrew not found. Installing Homebrew..."
    
    {{- if .is_linux }}
    # Install dependencies for Linux
    echo "Installing Homebrew dependencies for Linux..."
    if command -v apt-get &> /dev/null; then
        sudo apt-get update
        sudo apt-get install -y build-essential procps curl file git
    elif command -v yum &> /dev/null; then
        sudo yum groupinstall -y 'Development Tools'
        sudo yum install -y procps-ng curl file git
    elif command -v dnf &> /dev/null; then
        sudo dnf groupinstall -y 'Development Tools'
        sudo dnf install -y procps-ng curl file git
    elif command -v pacman &> /dev/null; then
        sudo pacman -Sy --needed base-devel procps-ng curl file git
    fi
    {{- end }}
    
    # Install Homebrew using the official installation script
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add Homebrew to PATH for the current session
    {{- if .is_macos }}
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        # Apple Silicon Mac
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f "/usr/local/bin/brew" ]]; then
        # Intel Mac
        eval "$(/usr/local/bin/brew shellenv)"
    fi
    {{- else if .is_linux }}
    # Linux installation path
    if [[ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]]; then
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    elif [[ -f "$HOME/.linuxbrew/bin/brew" ]]; then
        eval "$($HOME/.linuxbrew/bin/brew shellenv)"
    fi
    {{- end }}
    
    echo "Homebrew installed successfully!"
    
    # Update Homebrew
    echo "Updating Homebrew..."
    brew update
    
    # Install essential packages
    echo "Installing essential Homebrew packages..."
    brew install \
        coreutils \
        findutils \
        gnu-sed \
        gawk \
        grep \
        curl \
        wget \
        git \
        jq \
        ripgrep \
        fd \
        bat \
        eza \
        delta \
        gh
        
    echo "Essential packages installed!"
else
    echo "Homebrew is already installed at $(which brew)"
    
    # Ensure Homebrew is up to date
    echo "Updating Homebrew..."
    brew update
fi

# Verify installation
if command -v brew &> /dev/null; then
    echo "✓ Homebrew is ready!"
    echo "  Version: $(brew --version | head -n1)"
    echo "  Location: $(which brew)"
else
    echo "✗ Homebrew installation failed!"
    exit 1
fi